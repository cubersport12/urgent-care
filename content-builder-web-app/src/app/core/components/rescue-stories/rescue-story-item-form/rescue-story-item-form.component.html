<form class="flex flex-col gap-4" [formGroup]="_form">

  <!-- Scene Editor -->
  <div class="scene-editor">
    <!-- Tree Panel (Left) -->
    <div class="tree-panel">
      <app-rescue-library-tree (itemSelect)="_onTreeItemSelect($event)"></app-rescue-library-tree>
    </div>

    <!-- Image Panel (Center) -->
    <div class="image-panel">
      <button 
        type="button"
        mat-flat-button 
        color="primary"
        class="upload-button"
        (click)="_triggerFileInput()">
        <mat-icon [svgIcon]="'upload'"></mat-icon>
        Загрузить изображение
      </button>
      <input 
        #fileInput
        type="file" 
        accept="image/*" 
        style="display: none;"
        (change)="_onFileSelected($event)">
      
      <div 
        #imageContainer
        class="image-container"
        [class.has-image]="_imagePreviewUrl()"
        (dragover)="_onImageContainerDragOver($event)"
        (drop)="_onImageContainerDrop($event)"
        (click)="_onImageContainerClick($event)">
        @if (_imagePreviewUrl()) {
          <img [src]="_imagePreviewUrl()!" class="scene-image" alt="Scene background">
        } @else {
          <div class="flex items-center justify-center h-full text-gray-400">
            Перетащите изображение или нажмите кнопку загрузки
          </div>
        }
        
        @for (trigger of storyData().scene.items; track trigger.triggerId) {
          <div 
            class="scene-element"
            [class.selected]="_isElementSelected(trigger)"
            [style]="_getElementStyle(trigger)"
            draggable="true"
            (click)="_onElementClick(trigger, $event)"
            (dragstart)="_onElementDragStart($event, trigger)"
            (dragend)="_onElementDragEnd()">
            <mat-icon [svgIcon]="_getItemIcon(trigger.triggerId)"></mat-icon>
            <!-- <span class="ml-1 text-xs">{{ _getItemName(trigger.triggerId) }}</span> -->
          </div>
        }
      </div>
    </div>

    <!-- Params Panel (Right) -->
    <div class="params-panel">
      @if (_selectedElement()) {
        <div class="flex flex-col gap-1">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium">Параметры элемента</h3>
            <button 
              type="button"
              mat-icon-button
              color="warn"
              (click)="_deleteSelectedElement()">
              <mat-icon [svgIcon]="'trash'"></mat-icon>
            </button>
          </div>
          <div class="text-sm text-gray-600 mb-2">
            {{ _getItemName(_selectedElement()!.triggerId) }}
          </div>
          
          <form [formGroup]="_elementParamsForm" class="flex flex-col gap-1">
            <div class="flex gap-1">
              <mat-form-field appearance="fill" class="grow">
                <mat-label>Позиция X (%)</mat-label>
                <input 
                  matInput 
                  type="number"
                  [formControl]="_elementParamsForm.controls.positionX"
                  min="0"
                  max="100">
              </mat-form-field>
              
              <mat-form-field appearance="fill" class="grow">
                <mat-label>Позиция Y (%)</mat-label>
                <input 
                  matInput 
                  type="number"
                  [formControl]="_elementParamsForm.controls.positionY"
                  min="0"
                  max="100">
              </mat-form-field>
            </div>
            
            <div class="flex gap-1">
              <mat-form-field appearance="fill" class="grow">
                <mat-label>Ширина (%)</mat-label>
                <input 
                  matInput 
                  type="number"
                  [formControl]="_elementParamsForm.controls.width"
                  min="1"
                  max="100">
              </mat-form-field>
              
              <mat-form-field appearance="fill" class="grow">
                <mat-label>Высота (%)</mat-label>
                <input 
                  matInput 
                  type="number"
                  [formControl]="_elementParamsForm.controls.height"
                  min="1"
                  max="100">
              </mat-form-field>
            </div>
          </form>

          <mat-expansion-panel [expanded]="false" class="mt-2">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <h4 class="text-md font-medium m-0">Влияющие параметры</h4>
              </mat-panel-title>
            </mat-expansion-panel-header>
            @if (_isSelectedTrigger()) {
              <div class="pt-2 overflow-auto">
                @if (_triggerTableItems().length > 0 && _availableParameters().length > 0) {
                  <table mat-table [dataSource]="_triggerTableItems()" class="w-full">
                    <!-- Column: Item Name -->
                    <ng-container matColumnDef="itemName">
                      <th mat-header-cell *matHeaderCellDef>Элемент</th>
                      <td mat-cell *matCellDef="let item">{{ item.name }}</td>
                    </ng-container>

                    <!-- Dynamic Columns: Parameters -->
                    @for (parameter of _availableParameters(); track parameter.id) {
                      <ng-container [matColumnDef]="'param_' + parameter.id">
                        <th mat-header-cell *matHeaderCellDef>{{ parameter.label }}</th>
                        <td mat-cell *matCellDef="let item">
                          @if (parameter.category === 'duration') {
                            @if (_getTriggerParameterControl(item.id, parameter.id); as control) {
                              <input
                              type="time"
                              step="1"
                              [formControl]="control"
                              (keydown)="_onRestrictionInputKeyDown($event)"
                              (keyup)="$event.stopPropagation()"
                              placeholder="00:00:00">
                            }
                          } @else {
                            @if (_getTriggerParameterControl(item.id, parameter.id); as control) {
                              <input
                                  type="number"
                                  [formControl]="control"
                                  (keydown)="_onRestrictionInputKeyDown($event)"
                                  (keyup)="$event.stopPropagation()"
                                  placeholder="Введите значение">
                            }
                          }
                        </td>
                      </ng-container>
                    }

                    <tr mat-header-row *matHeaderRowDef="_getTableDisplayedColumns()"></tr>
                    <tr mat-row *matRowDef="let row; columns: _getTableDisplayedColumns();"></tr>
                  </table>
                } @else {
                  <div class="text-sm text-gray-500">
                    @if (_triggerTableItems().length === 0) {
                      Нет элементов для отображения
                    } @else {
                      Нет доступных параметров
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="pt-2">
                <div class="flex flex-col gap-2">
                  @if (_isTestOrQuestion()) {
                    <div class="mb-2 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
                      <strong>Подсказка:</strong> Для теста и вопроса будет применяться коэффициент 1 или -1 в зависимости от успешности прохождения теста.
                    </div>
                  }
                  @for (parameter of _availableParameters(); track parameter.id) {
                    <div class="flex items-center gap-2">
                      <span class="text-sm min-w-32 w-32 flex-1">{{ parameter.label }}</span>
                      @if (_isParameterInElementParameters(parameter.id)) {
                        @if (parameter.category === 'duration') {
                          @if (_getElementParameterControl(parameter.id); as control) {
                            <mat-form-field appearance="fill" class="grow">
                              <mat-label>Значение (HH:mm:ss)</mat-label>
                              <input
                                matInput
                                type="time"
                                step="1"
                                [formControl]="control"
                                (keydown)="_onRestrictionInputKeyDown($event)"
                                (keyup)="$event.stopPropagation()"
                                placeholder="00:00:00">
                            </mat-form-field>
                          }
                        } @else {
                          @if (_getElementParameterControl(parameter.id); as control) {
                            <mat-form-field appearance="fill" class="grow">
                              <mat-label>Значение</mat-label>
                              <input
                                matInput
                                type="number"
                                [formControl]="control"
                                (keydown)="_onRestrictionInputKeyDown($event)"
                                (keyup)="$event.stopPropagation()"
                                placeholder="Введите значение">
                            </mat-form-field>
                          }
                        }
                        <button
                          type="button"
                          mat-icon-button
                          color="warn"
                          (click)="_removeElementParameter(parameter.id)">
                          <mat-icon [svgIcon]="'trash'"></mat-icon>
                        </button>
                      } @else {
                        <button
                          type="button"
                          mat-stroked-button
                          (click)="_updateElementParameter(parameter.id, parameter.category === 'duration' ? '00:00:00' : 0)">
                          Установить
                        </button>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </mat-expansion-panel>

          <mat-expansion-panel [expanded]="false" class="mt-2">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <h4 class="text-md font-medium m-0">Условия видимости</h4>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="pt-2">
              <div class="flex flex-col gap-2">
                @for (parameter of _availableParameters(); track parameter.id) {
                  <div class="flex items-center gap-2">
                    <span class="text-sm flex-1 min-w-32 w-32">{{ parameter.label }}</span>
                    @if (_isParameterInVisibleParams(parameter.id)) {
                      @if (parameter.category === 'duration') {
                        @if (_getVisibleParamControl(parameter.id); as control) {
                          <mat-form-field appearance="fill" class="grow">
                            <mat-label>Значение (HH:mm:ss)</mat-label>
                            <input
                              matInput
                              type="time"
                              step="1"
                              [formControl]="control"
                              (keydown)="_onRestrictionInputKeyDown($event)"
                              (keyup)="$event.stopPropagation()"
                              placeholder="00:00:00">
                          </mat-form-field>
                        }
                      } @else {
                        @if (_getVisibleParamControl(parameter.id); as control) {
                          <mat-form-field appearance="fill" class="grow">
                            <mat-label>Значение</mat-label>
                            <input
                              matInput
                              type="number"
                              [formControl]="control"
                              (keydown)="_onRestrictionInputKeyDown($event)"
                              (keyup)="$event.stopPropagation()"
                              placeholder="Введите значение">
                          </mat-form-field>
                        }
                      }
                      <button
                        type="button"
                        mat-icon-button
                        color="warn"
                        (click)="_removeVisibleParam(parameter.id)">
                        <mat-icon [svgIcon]="'trash'"></mat-icon>
                      </button>
                    } @else {
                      <button
                        type="button"
                        mat-stroked-button
                        (click)="_updateVisibleParam(parameter.id, parameter.category === 'duration' ? '00:00:00' : 0)">
                        <mat-icon [svgIcon]="'plus'"></mat-icon>
                        Установить
                      </button>
                    }
                  </div>
                }
                @if (_availableParameters().length === 0) {
                  <div class="text-sm text-gray-500">Нет доступных параметров</div>
                }
              </div>
            </div>
          </mat-expansion-panel>
        </div>
      } @else {
        <div class="flex flex-col gap-1">
          <h3 class="text-lg font-medium mb-2">Параметры сцены</h3>
          
          <form [formGroup]="_form" class="flex flex-col gap-1">
            <mat-form-field appearance="fill">
              <mat-label>Название сюжета</mat-label>
              <input 
                matInput 
                [formControl]="_form.controls.name"
                placeholder="Введите название сюжета">
            </mat-form-field>
          </form>

          <mat-expansion-panel [expanded]="false">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <h4 class="text-md font-medium m-0">Ограничения перехода</h4>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="flex flex-col gap-2 pt-2">
              <small class="text-gray-600">Переход сработает, когда изначальное значение параметра сцены изменится на установленное значение в сцене по модулю - +-</small>
              @for (parameter of _availableParameters(); track parameter.id) {
                <div class="flex items-center gap-2">
                  <span class="text-sm flex-1">{{ parameter.label }}</span>
                  @if (_isParameterInRestrictions(parameter.id)) {
                    @if (parameter.category === 'duration') {
                      <mat-form-field appearance="fill" class="grow">
                        <mat-label>Значение (HH:mm:ss)</mat-label>
                        @if (_getRestrictionParamControl(parameter.id); as control) {
                          <input
                            matInput
                            size="sm"
                            type="time"
                            step="1"
                            [formControl]="control"
                            (keydown)="_onRestrictionInputKeyDown($event)"
                            (keyup)="$event.stopPropagation()"
                            placeholder="00:00:00">
                        }
                      </mat-form-field>
                    } @else {
                      <mat-form-field appearance="fill" class="grow">
                        <mat-label>Значение</mat-label>
                        @if (_getRestrictionParamControl(parameter.id); as control) {
                          <input
                            matInput
                            size="sm"
                            type="number"
                            [formControl]="control"
                            (keydown)="_onRestrictionInputKeyDown($event)"
                            (keyup)="$event.stopPropagation()"
                            placeholder="Введите значение">
                        }
                      </mat-form-field>
                    }
                    <button
                      type="button"
                      mat-icon-button
                      color="warn"
                      (click)="_removeRestrictionParam(parameter.id)">
                      <mat-icon [svgIcon]="'trash'"></mat-icon>
                    </button>
                  } @else {
                    <button
                      type="button"
                      mat-stroked-button
                      (click)="_updateRestrictionParam(parameter.id, parameter.category === 'duration' ? '00:00:00' : 0)">
                      <mat-icon [svgIcon]="'plus'"></mat-icon>
                      Установить
                    </button>
                  }
                </div>
              }
              @if (_availableParameters().length === 0) {
                <div class="text-sm text-gray-500">Нет доступных параметров</div>
              }
            </div>
          </mat-expansion-panel>
        </div>
      }
    </div>
  </div>
</form>
