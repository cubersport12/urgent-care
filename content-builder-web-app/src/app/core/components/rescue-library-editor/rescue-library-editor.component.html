<div class="flex flex-col w-full h-full">
  <div class="flex gap-2 p-2 border-b">
    <button mat-flat-button color="primary" [matMenuTriggerFor]="createMenu" [disabled]="_isPending() || !_canCreateChild()">
      <mat-icon svgIcon="plus" />
      Создать
    </button>
    <mat-menu #createMenu="matMenu">
      <button mat-menu-item (click)="_handleCreate('folder')">
        <mat-icon svgIcon="folder" />
        <span>Папка</span>
      </button>
      <button mat-menu-item (click)="_handleCreate('test')">
        <mat-icon svgIcon="file-circle-check" />
        <span>Тест</span>
      </button>
      <button mat-menu-item (click)="_handleCreate('question')">
        <mat-icon svgIcon="file-contract" />
        <span>Вопрос</span>
      </button>
      <button mat-menu-item (click)="_handleCreate('medicine')">
        <mat-icon svgIcon="kit-medical" />
        <span>Медикамент</span>
      </button>
    </mat-menu>
    <button mat-flat-button color="warn" (click)="_handleDelete()" [disabled]="_isPending() || !_selectedItem()">
      <mat-icon svgIcon="trash" />
      Удалить
    </button>
  </div>
  <div class="flex flex-1 overflow-hidden">
    <div class="tree-container">
      <div class="flex flex-col">
        @for (flatItem of _visibleItems(); track flatItem.item.id) {
          <button 
            class="w-full text-left p-2 hover:bg-gray-700 flex items-center" 
            (click)="_selectItem(flatItem.item)" 
            [class.bg-blue-100]="_selectedItem()?.id === flatItem.item.id" 
            [class.text-blue-900]="_selectedItem()?.id === flatItem.item.id"
            [style.padding-left.px]="flatItem.level * 20 + 8">

            <button 
              [style.opacity]="_hasChildren(flatItem.item.id) ? 1 : 0"
              class="mr-1 flex items-center justify-center hover:bg-gray-600 rounded"
              (click)="_toggleExpand(flatItem.item.id, $event)"
              type="button"
              [title]="_isExpanded(flatItem.item.id) ? 'Свернуть' : 'Развернуть'">
              <mat-icon [svgIcon]="_isExpanded(flatItem.item.id) ? 'chevron-down' : 'chevron-right'">
              </mat-icon>
            </button>
            <mat-icon class=" mr-2" [svgIcon]="_getIconForType(flatItem.item.type)">
            </mat-icon>
            {{ flatItem.item.name }}
          </button>
        }
      </div>
    </div>
    <div class="form-container">
    @if (_selectedItem()) {
      <form class="flex flex-col gap-4" [formGroup]="_form" (ngSubmit)="_handleSubmit()">
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Наименование</mat-label>
          <input matInput [formControl]="_form.controls.name">
        </mat-form-field>
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Описание</mat-label>
          <textarea matInput [formControl]="_form.controls.description" rows="4"></textarea>
        </mat-form-field>
        <div class="flex justify-end gap-2">
          <button [disabled]="_form.invalid || !_form.dirty || _isPending()" type="submit" mat-flat-button color="primary">
            <mat-icon [svgIcon]="_isPending() ? 'spinner' : 'check'" />
            Сохранить
          </button>
        </div>
      </form>
    } @else {
      <div class="flex items-center justify-center h-full text-gray-500">
        Выберите элемент из дерева для редактирования
      </div>
    }
  </div>
</div>
